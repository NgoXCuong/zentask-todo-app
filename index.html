<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zen Task - Qu·∫£n l√Ω c√¥ng vi·ªác Pro</title>
    <style>
      /* --- CSS C∆† B·∫¢N GI·ªÆ NGUY√äN, TH√äM C√ÅC PH·∫¶N M·ªöI --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
        line-height: 1.6;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header & User Info */
      .header {
        text-align: center;
        margin-bottom: 20px;
        color: white;
      }
      .header h1 {
        font-size: 2.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .todo-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .user-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
      }

      /* --- 1. CSS CHO PH·∫¶N TH·ªêNG K√ä (M·ªöI) --- */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }
      .stat-card {
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-3px);
      }
      .stat-card h2 {
        font-size: 2rem;
        margin: 5px 0;
      }
      .stat-card p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .bg-pending {
        background: linear-gradient(45deg, #f6d365 0%, #fda085 100%);
      }
      .bg-inprogress {
        background: linear-gradient(45deg, #89f7fe 0%, #66a6ff 100%);
      }
      .bg-completed {
        background: linear-gradient(45deg, #42e695 0%, #3bb2b8 100%);
      }

      /* --- 2. CSS CHO THANH T√åM KI·∫æM (M·ªöI) --- */
      .controls-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
      }
      .search-box {
        flex: 1;
        position: relative;
        min-width: 200px;
      }
      .search-box input {
        width: 100%;
        padding: 10px 15px;
        padding-left: 35px;
        border: 2px solid #e1e5e9;
        border-radius: 25px;
      }
      .search-icon {
        position: absolute;
        left: 12px;
        top: 12px;
        color: #999;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-secondary {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #ddd;
      }
      .btn-danger {
        background: #ff6b6b;
        color: white;
      }
      .btn-success {
        background: #51cf66;
        color: white;
      }
      .btn.active {
        background: #667eea;
        color: white;
        border-color: transparent;
      }

      /* Task List */
      .task-item {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.2s;
      }
      .task-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .task-status {
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .st-pending {
        background: #fff3cd;
        color: #856404;
      }
      .st-inprogress {
        background: #cce5ff;
        color: #004085;
      }
      .st-completed {
        background: #d4edda;
        color: #155724;
      }

      /* Utilities */
      .hidden {
        display: none;
      }
      .message {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        display: none;
        text-align: center;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .add-task-toggle {
        background: #f1f3f5;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 20px;
      }
      .add-form-container {
        display: none;
        margin-bottom: 20px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöÄ Zen Task Pro</h1>
        <p>Qu·∫£n l√Ω c√¥ng vi·ªác th√¥ng minh</p>
      </div>

      <div class="todo-section">
        <div class="user-header">
          <div class="user-info">
            <h3>Xin ch√†o, <span id="userName">User</span>! üëã</h3>
          </div>
          <button class="btn btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <div id="appMessage" class="message"></div>

        <div class="stats-container">
          <div class="stat-card bg-pending">
            <p>Ch∆∞a b·∫Øt ƒë·∫ßu</p>
            <h2 id="stat-pending">0</h2>
          </div>
          <div class="stat-card bg-inprogress">
            <p>ƒêang l√†m</p>
            <h2 id="stat-inprogress">0</h2>
          </div>
          <div class="stat-card bg-completed">
            <p>Ho√†n th√†nh</p>
            <h2 id="stat-completed">0</h2>
          </div>
        </div>

        <div class="add-task-toggle" onclick="toggleAddForm()">
          + Th√™m c√¥ng vi·ªác m·ªõi
        </div>
        <div class="add-form-container" id="addForm">
          <div class="form-group">
            <input
              type="text"
              id="newTitle"
              placeholder="Ti√™u ƒë·ªÅ c√¥ng vi·ªác..."
            />
          </div>
          <div class="form-group">
            <textarea
              id="newDesc"
              placeholder="M√¥ t·∫£ chi ti·∫øt..."
              rows="2"
            ></textarea>
          </div>
          <div class="form-group" style="display: flex; gap: 10px">
            <select id="newStatus">
              <option value="pending">Pending</option>
              <option value="inprogress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
            <input type="date" id="newDueDate" />
          </div>
          <button
            class="btn btn-primary"
            style="width: 100%"
            onclick="createTask()"
          >
            L∆∞u c√¥ng vi·ªác
          </button>
        </div>

        <div class="controls-container">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input
              type="text"
              id="searchInput"
              placeholder="T√¨m ki·∫øm c√¥ng vi·ªác..."
              onkeyup="debounceSearch()"
            />
          </div>
          <div class="task-filters">
            <button class="btn btn-secondary active" onclick="filterTasks('')">
              T·∫•t c·∫£
            </button>
            <button class="btn btn-secondary" onclick="filterTasks('pending')">
              Ch·ªù
            </button>
            <button
              class="btn btn-secondary"
              onclick="filterTasks('inprogress')"
            >
              ƒêang l√†m
            </button>
            <button
              class="btn btn-secondary"
              onclick="filterTasks('completed')"
            >
              Xong
            </button>
          </div>
        </div>

        <div id="loading" class="loading hidden">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        <div id="taskList"></div>

        <div
          id="pagination"
          style="
            text-align: center;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 5px;
          "
        ></div>
      </div>
    </div>

    <script>
      // --- C·∫§U H√åNH ---
      const API_BASE = "http://localhost:3000/api";

      // State Management (Qu·∫£n l√Ω tr·∫°ng th√°i)
      let state = {
        page: 1,
        limit: 5,
        status: "",
        keyword: "",
        totalPages: 1,
      };

      // --- KH·ªûI T·∫†O ---
      document.addEventListener("DOMContentLoaded", () => {
        checkAuth();
        loadStats(); // G·ªçi API Th·ªëng k√™
        loadTasks(); // G·ªçi API Danh s√°ch
      });

      // --- H√ÄM API G·ªêC (H·ªó tr·ª£ Cookie HttpOnly) ---
      async function apiCall(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: { "Content-Type": "application/json" },
          credentials: "include", // üî• QUAN TR·ªåNG: ƒê·ªÉ g·ª≠i cookie ƒëi
        };
        if (body) options.body = JSON.stringify(body);

        try {
          const res = await fetch(API_BASE + endpoint, options);

          // N·∫øu l·ªói 401 (Unauthorized) -> ƒê√° v·ªÅ login
          if (res.status === 401) {
            localStorage.removeItem("user");
            window.location.href = "login.html";
            return { ok: false };
          }

          const data = await res.json();
          return { data, ok: res.ok };
        } catch (e) {
          showMessage("L·ªói k·∫øt n·ªëi server", true);
          return { ok: false };
        }
      }

      // --- C√ÅC CH·ª®C NƒÇNG CH√çNH ---

      // 1. Load Th·ªëng K√™ (/stats)
      async function loadStats() {
        const { data, ok } = await apiCall("/tasks/stats");
        if (ok && data.stats) {
          document.getElementById("stat-pending").innerText =
            data.stats.pending || 0;
          document.getElementById("stat-inprogress").innerText =
            data.stats.inprogress || 0;
          document.getElementById("stat-completed").innerText =
            data.stats.completed || 0;
        }
      }

      // 2. Load Danh S√°ch (C√≥ Ph√¢n trang, L·ªçc, T√¨m ki·∫øm)
      async function loadTasks() {
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("taskList").innerHTML = "";

        // X√¢y d·ª±ng URL query string t·ª´ state
        const query = new URLSearchParams({
          page: state.page,
          limit: state.limit,
          status: state.status,
          keyword: state.keyword,
          sort_by: "created_at",
          order: "DESC",
        }).toString();

        const { data, ok } = await apiCall(`/tasks?${query}`);
        document.getElementById("loading").classList.add("hidden");

        if (ok) {
          state.totalPages = data.meta.totalPages;
          renderTasks(data.data);
          renderPagination();
        }
      }

      function renderTasks(tasks) {
        const list = document.getElementById("taskList");
        if (!tasks.length) {
          list.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o.</div>`;
          return;
        }

        list.innerHTML = tasks
          .map(
            (t) => `
          <div class="task-item">
            <div style="flex:1">
              <h4 style="margin-bottom:5px">${t.title}</h4>
              <p style="color:#666; font-size:0.9rem; margin-bottom:5px">${
                t.description || ""
              }</p>
              <div>
                <span class="task-status st-${t.status}">${t.status}</span>
                <span style="font-size:0.8rem; color:#999; margin-left:10px">üìÖ ${
                  t.due_date
                    ? new Date(t.due_date).toLocaleDateString()
                    : "Kh√¥ng th·ªùi h·∫°n"
                }</span>
              </div>
              <div id="edit-box-${
                t.id
              }" class="hidden" style="margin-top:10px; background:#f8f9fa; padding:10px; border-radius:5px;">
                 <input id="edit-title-${t.id}" value="${
              t.title
            }" style="margin-bottom:5px">
                 <select id="edit-status-${t.id}" style="margin-bottom:5px">
                    <option value="pending" ${
                      t.status == "pending" ? "selected" : ""
                    }>Pending</option>
                    <option value="inprogress" ${
                      t.status == "inprogress" ? "selected" : ""
                    }>In Progress</option>
                    <option value="completed" ${
                      t.status == "completed" ? "selected" : ""
                    }>Completed</option>
                 </select>
                 <button class="btn btn-sm btn-primary" onclick="saveEdit(${
                   t.id
                 })">L∆∞u</button>
                 <button class="btn btn-sm btn-secondary" onclick="document.getElementById('edit-box-${
                   t.id
                 }').classList.add('hidden')">H·ªßy</button>
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px; margin-left:10px;">
               <button class="btn btn-secondary" style="padding:5px 10px; font-size:0.8rem" onclick="document.getElementById('edit-box-${
                 t.id
               }').classList.remove('hidden')">‚úèÔ∏è</button>
               <button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem" onclick="deleteTask(${
                 t.id
               })">üóëÔ∏è</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      // 3. T·∫°o m·ªõi Task
      async function createTask() {
        const title = document.getElementById("newTitle").value;
        const description = document.getElementById("newDesc").value;
        const status = document.getElementById("newStatus").value;
        const due_date = document.getElementById("newDueDate").value;

        if (!title) return showMessage("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!", true);

        const { ok } = await apiCall("/tasks", "POST", {
          title,
          description,
          status,
          due_date,
        });

        if (ok) {
          showMessage("Th√™m th√†nh c√¥ng!");
          toggleAddForm(); // ƒê√≥ng form
          loadTasks(); // Load l·∫°i list
          loadStats(); // Load l·∫°i th·ªëng k√™
          // Reset input
          document.getElementById("newTitle").value = "";
          document.getElementById("newDesc").value = "";
        }
      }

      // 4. X√≥a Task
      async function deleteTask(id) {
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
        const { ok } = await apiCall(`/tasks/${id}`, "DELETE");
        if (ok) {
          loadTasks();
          loadStats();
        }
      }

      // 5. C·∫≠p nh·∫≠t Task
      async function saveEdit(id) {
        const title = document.getElementById(`edit-title-${id}`).value;
        const status = document.getElementById(`edit-status-${id}`).value;

        const { ok } = await apiCall(`/tasks/${id}`, "PUT", { title, status });
        if (ok) {
          loadTasks();
          loadStats();
        }
      }

      // --- C√ÅC H√ÄM H·ªñ TR·ª¢ UI ---

      // Debounce Search (G√µ xong 0.5s m·ªõi t√¨m)
      let timeout = null;
      function debounceSearch() {
        const val = document.getElementById("searchInput").value;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          state.keyword = val;
          state.page = 1; // Reset v·ªÅ trang 1 khi t√¨m ki·∫øm
          loadTasks();
        }, 500);
      }

      // Filter Buttons
      function filterTasks(status) {
        state.status = status;
        state.page = 1; // Reset v·ªÅ trang 1

        // Update UI button active
        document
          .querySelectorAll(".task-filters .btn")
          .forEach((b) => b.classList.remove("active"));
        event.target.classList.add("active");

        loadTasks();
      }

      // Pagination UI
      function renderPagination() {
        const container = document.getElementById("pagination");
        let html = "";

        // N√∫t Prev
        html += `<button class="btn btn-secondary" ${
          state.page === 1 ? "disabled" : ""
        } onclick="changePage(${state.page - 1})">Prev</button>`;

        // S·ªë trang
        for (let i = 1; i <= state.totalPages; i++) {
          html += `<button class="btn ${
            i === state.page ? "btn-primary" : "btn-secondary"
          }" onclick="changePage(${i})">${i}</button>`;
        }

        // N√∫t Next
        html += `<button class="btn btn-secondary" ${
          state.page === state.totalPages ? "disabled" : ""
        } onclick="changePage(${state.page + 1})">Next</button>`;

        container.innerHTML = html;
      }

      function changePage(newPage) {
        if (newPage < 1 || newPage > state.totalPages) return;
        state.page = newPage;
        loadTasks();
      }

      function checkAuth() {
        const user = localStorage.getItem("user");
        if (!user) window.location.href = "login.html";
        else
          document.getElementById("userName").innerText =
            JSON.parse(user).full_name || "User";
      }

      async function logout() {
        await apiCall("/users/logout", "POST");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }

      function toggleAddForm() {
        const form = document.getElementById("addForm");
        form.style.display = form.style.display === "block" ? "none" : "block";
      }

      function showMessage(text, isError = false) {
        const msg = document.getElementById("appMessage");
        msg.innerText = text;
        msg.style.display = "block";
        msg.style.background = isError ? "#ffdddd" : "#ddffdd";
        msg.style.color = isError ? "#d8000c" : "#4f8a10";
        setTimeout(() => (msg.style.display = "none"), 3000);
      }
    </script>
  </body>
</html>
